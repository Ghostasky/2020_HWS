[TOC]
# 课程三：PWN-栈利用之对抗linux保护

## 3.1.Linux保护技术

### 3.1.1 NX 保护

#### 作用

​	将数据（栈，堆）所在内存页标识为不可执行，当程序成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。

#### 编译选项

-   关闭：-z execstack
-   开启：-z noexecstack

### 3.1.2 PIE 保护

#### 作用

使得程序地址空间分布随机化，增加ROP等利用的难度。（因为地址都是不确定的了）

#### 编译选项

-    关闭： -no-pie

-    开启： -pie -fPIC

### 3.1.3  canary保护

#### 作用

​	函数开始执行的时候会先往栈里插入canary值，当函数真正返回的时候会验证canary值是否合法，如果不合法就停止程序运行。可以防止栈溢出覆盖返回地址。

#### 编译选项

-   关闭：-fno-stack-protector

-   启用（只为局部变量中含有char的函数插入保护代码）：

    -fstack-protector
-   启用（为所有函数插入保护代码）：-fstack-proctor-all



### 3.1.4 Fortify保护

#### 作用：

主要用来防止格式化字符串漏洞。包含%n的格式化字符串不能位于程序内存中的可写地址。当使用位置参数时，必须使用范围内的所有参数，如果要使用%7\$x，必须同时使用1\$2\$3\$4\$5\$6\$。

#### 编译选项

-   关闭： -D_FORTIFY_SOURCE=0

-   开启：-D_FORTIFY_SOURCE=2

### 3.1.5 RELRO保护

#### 作用

设置符号重定位表为只读，并在程序启动时就解析并绑定所有动态符号，从而对GOT表攻击。

#### 编译选项

-   开启（部分）：-z lazy

-   开启（全部）：-z now

## 3.2 对抗DEP/NX保护

![image-20210729192208323](Day3/image-20210729192208323.png)

![image-20210729192222218](Day3/image-20210729192222218.png)

![image-20210729192406674](Day3/image-20210729192406674.png)

![image-20210729192813320](Day3/image-20210729192813320.png)

![image-20210729192948755](Day3/image-20210729192948755.png)

![image-20210729193103231](Day3/image-20210729193103231.png)

![image-20210729193140087](Day3/image-20210729193140087.png)

![image-20210729193355960](Day3/image-20210729193355960.png)

![image-20210729194009625](Day3/image-20210729194009625.png)

![image-20210729194338416](Day3/image-20210729194338416.png)

![image-20210729194439832](Day3/image-20210729194439832.png)

![image-20210729194514787](Day3/image-20210729194514787.png)

## 3.3 对抗ASLR/PIE保护

![image-20210729195126071](Day3/image-20210729195126071.png)

![image-20210729195251625](Day3/image-20210729195251625.png)

![image-20210729195454975](Day3/image-20210729195454975.png)

![image-20210729195541530](Day3/image-20210729195541530.png)

![image-20210729195609942](Day3/image-20210729195609942.png)

![image-20210729195633306](Day3/image-20210729195633306.png)

![image-20210729195728522](Day3/image-20210729195728522.png)

![image-20210729200052914](Day3/image-20210729200052914.png)

## 3.4 对抗Canary保护

![image-20210729200428183](Day3/image-20210729200428183.png)

![image-20210729200549586](Day3/image-20210729200549586.png)

![image-20210729200710056](Day3/image-20210729200710056.png)

![image-20210729200819344](Day3/image-20210729200819344.png)

![image-20210729200849647](Day3/image-20210729200849647.png)

![image-20210729200914132](Day3/image-20210729200914132.png)

![image-20210729200935165](Day3/image-20210729200935165.png)

![image-20210729201551799](Day3/image-20210729201551799.png)

 ![image-20210729201709676](Day3/image-20210729201709676.png)

![image-20210729201755542](Day3/image-20210729201755542.png)

![image-20210729201905088](Day3/image-20210729201905088.png)

![image-20210729201926879](Day3/image-20210729201926879.png)

![image-20210729201954256](Day3/image-20210729201954256.png)

![image-20210729202053855](Day3/image-20210729202053855.png)

![image-20210729202138848](Day3/image-20210729202138848.png)

![image-20210729202240327](Day3/image-20210729202240327.png)

![image-20210729202349648](Day3/image-20210729202349648.png)

![image-20210729202440092](Day3/image-20210729202440092.png)

![image-20210729202528380](Day3/image-20210729202528380.png)

## 3.5 扩展小问题

![image-20210729203602064](Day3/image-20210729203602064.png)

![image-20210729204032138](Day3/image-20210729204032138.png)

![image-20210729204513695](Day3/image-20210729204513695.png)

![image-20210729204613505](Day3/image-20210729204613505.png)

![image-20210729204638630](Day3/image-20210729204638630.png)

![image-20210729204734041](Day3/image-20210729204734041.png)

![image-20210729204845290](Day3/image-20210729204845290.png)

![image-20210729205617868](Day3/image-20210729205617868.png)

![image-20210729211719427](Day3/image-20210729211719427.png)

![image-20210729211822759](Day3/image-20210729211822759.png)

![image-20210729212038598](Day3/image-20210729212038598.png)

![image-20210729212213992](Day3/image-20210729212213992.png)

## 3.6 格式化字符串漏洞

![image-20210729212336474](Day3/image-20210729212336474.png)

![image-20210729212419649](Day3/image-20210729212419649.png)

![image-20210729212614079](Day3/image-20210729212614079.png)

![image-20210729212710603](Day3/image-20210729212710603.png)

![image-20210729212724231](Day3/image-20210729212724231.png)

![image-20210729212824211](Day3/image-20210729212824211.png)

![image-20210729212903045](Day3/image-20210729212903045.png)

![image-20210729213105830](Day3/image-20210729213105830.png)

![image-20210729213204051](Day3/image-20210729213204051.png)





